---
- name: Bootstrap Zabbix GUI via API
  hosts: all
  gather_facts: false
  vars:
    zbx_api_url: "http://{{ inventory_hostname }}/zabbix/api_jsonrpc.php"
    zbx_admin_user: "Admin"
    zbx_admin_pass: "zabbix"
    zbx_admin_new_pass: "admin@123"
    zbx_api_user: "ansible"
    zbx_api_password: "admin@123"

  tasks:
    - name: Change default Admin password
      zabbix.zabbix.zabbix_user:
        server_url: "{{ zbx_api_url }}"
        login_user: "{{ zbx_admin_user }}"
        login_password: "{{ zbx_admin_pass }}"
        username: "{{ zbx_admin_user }}"
        password: "{{ zbx_admin_new_pass }}"
        state: present

    - name: Create ansible API user
      zabbix.zabbix.zabbix_user:
        server_url: "{{ zbx_api_url }}"
        login_user: "{{ zbx_admin_user }}"
        login_password: "{{ zbx_admin_new_pass }}"
        username: "{{ zbx_api_user }}"
        first_name: "Ansible"
        last_name: "Automation"
        password: "{{ zbx_api_password }}"
        role: "Super admin role"
        state: present

    - name: Ensure host group Linux
      zabbix.zabbix.zabbix_group:
        server_url: "{{ zbx_api_url }}"
        login_user: "{{ zbx_api_user }}"
        login_password: "{{ zbx_api_password }}"
        name: Linux
        state: present

    - name: Register the Zabbix server as a host
      zabbix.zabbix.zabbix_host:
        server_url: "{{ zbx_api_url }}"
        login_user: "{{ zbx_api_user }}"
        login_password: "{{ zbx_api_password }}"
        host_name: "{{ inventory_hostname }}"
        visible_name: "{{ inventory_hostname }}"
        host_groups: 
          - Linux
        interfaces:
          - type: agent
            main: true
            useip: true
            ip: "{{ lookup('ansible.builtin.pipe', 'hostname -I').split()[0] }}"
            dns: ""
            port: 10050
        link_templates:
          - "Linux by Zabbix agent active"
        status: enabled
        state: present
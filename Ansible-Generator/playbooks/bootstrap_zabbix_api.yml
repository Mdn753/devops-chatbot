---
- name: Bootstrap Zabbix GUI via API
  hosts: all
  gather_facts: false
  vars:
    zbx_api_url: "http://{{ inventory_hostname }}/zabbix/api_jsonrpc.php"
    zbx_admin_user: "Admin"
    zbx_admin_pass: "zabbix"
    zbx_admin_new_pass: "SuperSecretAdminPW"
    zbx_api_user: "ansible"
    zbx_api_password: "admin@123"

  tasks:
    - name: Change default Admin password
      community.zabbix.zabbix_user:
        server_url: "{{ zbx_api_url }}"
        login_user: "{{ zbx_admin_user }}"
        login_password: "{{ zbx_admin_pass }}"
        alias: Admin
        passwd: "{{ zbx_admin_new_pass }}"
        state: present

    - name: Create ansible API user
      community.zabbix.zabbix_user:
        server_url: "{{ zbx_api_url }}"
        login_user: "{{ zbx_admin_user }}"
        login_password: "{{ zbx_admin_new_pass }}"
        alias: "{{ zbx_api_user }}"
        name: Ansible Automation
        user_type: super_admin
        usrgrps: ["Zabbix administrators"]
        passwd: "{{ zbx_api_password }}"
        state: present

    - name: Ensure host group Linux
      community.zabbix.zabbix_hostgroup:
        server_url: "{{ zbx_api_url }}"
        login_user: "{{ zbx_api_user }}"
        login_password: "{{ zbx_api_password }}"
        name: Linux
        state: present

    - name: Register the Zabbix server as a host
      community.zabbix.zabbix_host:
        server_url: "{{ zbx_api_url }}"
        login_user: "{{ zbx_api_user }}"
        login_password: "{{ zbx_api_password }}"
        host_name: "{{ inventory_hostname }}"
        visible_name: "{{ inventory_hostname }}"
        host_groups: [Linux]
        interfaces:
          - type: agent
            main: 1
            useip: 1
            ip: "{{ lookup('ansible.builtin.pipe', 'hostname -I').split()[0] }}"
            dns: ""
            port: 10050
        templates:
          - "Linux by Zabbix agent active"
        status: enabled
        state: present
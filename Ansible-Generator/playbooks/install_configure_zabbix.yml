---
# file: site.yml
- name: Zabbix 5 LTS • Server + Web + Agent on every VM
  hosts: all                # the inventory (“vms”) supplies the actual VMs
  become: true
  gather_facts: true

  vars:
    # ── survey-friendly variables (override in the AWX Survey) ─────────────
    zabbix_version:             "5.0"

    mysql_root_password:        "root_pw"          # geerlingguy.mysql
    zabbix_db_password:         "StrongDBpass!"    # for db user
    zabbix_admin_password:      "zabbix"           # web-UI Admin
    php_timezone:               "Africa/Casablanca"

    # ── auto-generated DB names & users ───────────────────────────────────
    zabbix_db_name:  zabbix
    zabbix_db_user:  zabbix

    # ── geerlingguy.mysql role ────────────────────────────────────────────
    mysql_root_password: "{{ mysql_root_password }}"
    mysql_databases:
      - name: "{{ zabbix_db_name }}"
        encoding: utf8
        collation: utf8_bin
    mysql_users:
      - name: "{{ zabbix_db_user }}"
        host: localhost
        password: "{{ zabbix_db_password }}"
        priv: "{{ zabbix_db_name }}.*:ALL"

    # ── dj-wasabi.zabbix-server role ──────────────────────────────────────
    zabbix_server_version:          "{{ zabbix_version }}"
    zabbix_server_database_long:    mysql
    zabbix_server_dbname:           "{{ zabbix_db_name }}"
    zabbix_server_dbuser:           "{{ zabbix_db_user }}"
    zabbix_server_dbpassword:       "{{ zabbix_db_password }}"
    zabbix_database_sqlload:        true                 # import schema
    zabbix_api_create_user:         true
    zabbix_api_login_user:          "Admin"
    zabbix_api_login_pass:          "{{ zabbix_admin_password }}"

    # ── dj-wasabi.zabbix-web role ─────────────────────────────────────────
    zabbix_web_version:             "{{ zabbix_version }}"
    zabbix_web_timezone:            "{{ php_timezone }}"
    zabbix_web_language:            "en_US"

    # ── dj-wasabi.zabbix-agent role (local agent) ─────────────────────────
    zabbix_agent_server:            127.0.0.1
    zabbix_agent_serveractive:      127.0.0.1

  roles:
    - geerlingguy.mysql
    - dj-wasabi.zabbix-server
    - dj-wasabi.zabbix-web
    - dj-wasabi.zabbix-agent
